var fs = require('fs');
var BASE_PATH = fs.realpathSync(__dirname+'/../../');

function _formatPath(path){
	return path.replace(/\/{2,}/g,'/');
}

function parsePath(reqUrl){
	var html = '';
	var state = 404;
	var filePath = _formatPath(BASE_PATH+reqUrl);
	if(fs.existsSync(filePath)){
		var pathArr = reqUrl.split('/');
		var tempPathArr = [];
		var tempPath = '',pathUrl = '';

		tempPathArr.push('<a href="/">根目录</a>');
		pathArr.shift();
		while((tempPath = pathArr.shift()) != undefined){
			if(tempPath == ''){
				continue;
			}else{
				pathUrl += '/'+tempPath;
				tempPathArr.push('<a href="'+pathUrl+'">'+tempPath+'</a>');
			}
		}
		html += '<style>'+
					'ul{list-style:none;}'+
					'li{height:30px;line-height:30px;}'+
					'.title span{background:#ccc;}'+
					'span{background:#eee;display:inline-block;min-width:160px;width:18%;padding:0 5px;border:1px solid white;}'+
					'span.name{min-width:300px;width:38%}'+
				'</style>';
		html += '<h1>'+tempPathArr.join('/')+'</h1>';
		if(fs.lstatSync(filePath).isDirectory()){
			var files = fs.readdirSync(filePath);
			html += '<ul>';
			html += '<li class="title">'+
						'<span class="name">名称</span>'+
						'<span>创建时间</span>'+
						'<span>更新时间</span>'+
						'<span>访问时间</span>'+
					'</li>';
			var dirArr = [],fileArr = [];
			files.forEach(function(file){
				var pathname = _formatPath(filePath + '/' + file),
					stat = fs.lstatSync(pathname);
				var fileObj = {href:_formatPath(reqUrl+'/'+file),name:file,ctime:stat.ctime,mtime:stat.mtime,atime:stat.atime};
				if(stat.isDirectory()){
					dirArr.push(fileObj);
				}else if(stat.isFile()){
					fileArr.push(fileObj);
				}
			});
			[].concat.apply(dirArr,fileArr.slice(0)).forEach(function(file){
				html += '<li>'+
							'<span class="name"><a href="'+file.href+'">'+file.name+'</a></span>'+
							'<span>'+file.ctime.format()+'</span>'+
							'<span>'+file.mtime.format()+'</span>'+
							'<span>'+file.atime.format()+'</span>'+
						'</li>';
			});
			html += '</ul>';
		}else{
			html += '<textarea style="width:99%;height:80%">'+fs.readFileSync(filePath)+'</textarea>';
		}
		state = 200;
	}else{
		html = 'dont find this file,请查看<a href="http://github.com/tonny-zhang/wx">http://github.com/tonny-zhang/wx</a>';
	}
	return {
		state: state,
		html: html
	};
}
exports.parsePath = parsePath;
exports.formatPath = _formatPath;