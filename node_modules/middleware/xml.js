var xml = require("util/xml2json");
var utils = require('express/node_modules/connect').utils;

exports = module.exports = function(expressApp,options){
	var isMerge = (options || {}).isMerge;
	return function(req,res,next){
		if (req._body) return next();
		req.body = req.body || {};

		if (!utils.hasBody(req)) return next();

		// check Content-Type
		if ('text/xml' != utils.mime(req)) return next();

		// flag as parsed
		req._body = true;

		req.setEncoding('utf8');
		var buf = '';
		req.on('data', function(chunk){ buf += chunk });
		req.on('end', function(){
			xml.parse2Json(buf,function(err,result){
				if(err){
					 return next(err);
				}else{
					req.body = result;
					next();
				}
			},isMerge);
		});
	}
}